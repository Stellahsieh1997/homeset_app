<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- 匯入ionicons 字型圖標 -->
    <link rel="stylesheet" href="css/ionicons.min.css">
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <link rel=stylesheet type="text/css" href="../www/css/A01.css">
    <link type="text/css" rel="stylesheet" href="../www/css/mmenu.css" />
    <script type="text/javascript" charset="utf-8" src="cordova.js"></script>
    <title>收納資訊</title>
</head>


<body class="font container-fluid">

    <div class="lead" onclick="lead()">
        <div class="mask"></div>
        <p id="leadcaption" class="caption">點擊以新增我的收納技巧貼文</p>
        <img src="static/tap.png" id="leadarrow" class="arrow">
        <!-- <i class="icon ion-md-arrow-round-back arrow"></i> -->
        <div id="leadknow" class="know">我知道了</div>
    </div>


    <div class="row p-1  " style="background-color:transparent">
        <div class="header">
            <p>收納資訊</p>
        </div>
        <div class="col-4 title">
            <p style="margin:0px"></p>
        </div>
        <div class="col-4">
            <a href="A04.html">
                <button type="button" class="float-right buttontype"
                    style="background-color: transparent;border-color:transparent;margin-top:-55px;margin-right:-110px">
                    <img src="static/article.png" style=width:36px;>
                </button>
            </a>
        </div>
    </div>
    </div>

    <div class="content">
        <div class="container-fluid">
            <div class="row">
                <a class="btn btn-light col bpadding" href="A02.html?category=1" role="button">客廳</a>
                <a class="btn btn-light col bpadding" href="A02.html?category=2" role="button">廚房</a>
                <a class="btn btn-light col bpadding" href="A02.html?category=3" role="button">臥室</a>
            </div>
            <div class="row">
                <a class="btn btn-light col bpadding" href="A02.html?category=4" role="button">浴室</a>
                <a class="btn btn-light col bpadding" href="A02.html?category=5" role="button">技巧</a>
                <a class="btn btn-light col bpadding" href="A02.html?category=6" role="button">設計</a>
            </div>
            <div class="body" style="margin-top: 10px;font-size: 20px;color:gray;margin-left: 20px">
                <P>典藏文章</P>
            </div>
        </div>
    </div>
    <div id="likepost" style="margin-bottom:60px"></div>
    <div class="container-fluid  footer">
        <div class="row row1 ">
            <div class="col-4 icon">
                <a href="S01.html">
                    <i class="icon ion-md-search icon1"></i>
                </a> </div>
            <div class="col-4 icon ">
                <a href="H01.html">
                    <i class="icon ion-md-home icon1"></i>
                </a> </div>
            <div class="col-4 icon">
                <a href="A01.html">
                    <i class="icon ion-md-bookmarks icon1" style="color: #254F6E"></i>
                </a>
            </div>
        </div>
    </div>


    <script>

        //收藏
        var user_email;
        var user_token;
        document.addEventListener("deviceready", onDeviceReady, false);
        var db;
        function onDeviceReady() {
            db = window.sqlitePlugin.openDatabase({
                name: 'my.db',
                location: 'default',
            });
            //提醒跳轉
            cordova.plugins.notification.local.on("click", function (notification) {
                window.location.href = 'T01_edit.html?thing=' + notification.thingId + ''
            });
            db.transaction(function (tx) {
                tx.executeSql('CREATE TABLE IF NOT EXISTS user (id integer primary key, email text, token text, nickname text, backup text)');
                tx.executeSql('CREATE TABLE IF NOT EXISTS page (id integer primary key, home integer, furniture_page integer, search_page integer, post_page integer)');
            });

            db.transaction(function (tx) {

                tx.executeSql("SELECT * FROM page", [],
                    function (tx, res) {
                        var len = res.rows.length;
                        if (res.rows.length >= 1) {
                            var post_page = res.rows.item(0)['post_page']
                            if (!post_page) {
                                $(".lead").css('display', 'block');
                            }
                        }
                    });

                tx.executeSql('SELECT * FROM user', [],
                    function (tx, res) {
                        var len = res.rows.length;
                        if (res.rows.length >= 1) {
                            user_email = res.rows.item(0)['email']
                            user_token = res.rows.item(0)['token']
                            $.ajax({
                                headers: {
                                    "Authorization": "Token " + user_token + ""
                                },
                                type: "GET",
                                url: "http://140.131.114.157/posts/likes",
                                error: function (err) {
                                    alert(JSON.stringify(err))
                                },
                                success: function (res) {
                                    if (res.length >= 1) {
                                        for (i = res.length - 1; i >= 0; i--) {
                                            var category
                                            switch (parseInt(res[i].category)) {
                                                case 1:
                                                    category = "客廳";
                                                    break;
                                                case 2:
                                                    category = "廚房";
                                                    break;
                                                case 3:
                                                    category = "臥室";
                                                    break;
                                                case 4:
                                                    category = "浴室";
                                                    break;
                                                case 5:
                                                    category = "技巧";
                                                    break;
                                                case 6:
                                                    category = "設計";
                                                    break;
                                                default:
                                                    category = "無類別";
                                            }
                                            var title = res[i].title;
                                            if (title.length > 25) {
                                                title = res[i].title.substr(0, 24) + "...";
                                            }
                                            var post = `<div style="position: relative">
                                                    <i class="icon collection ion-md-heart" id="post`+ res[i].id + `" onclick="collection('` + res[i].id + `')"></i>
                                                    <h6 class="nicknamestyle">`+ res[i].nickname + `</h6>
                                                    <p class="likes" id="likes`+ res[i].id + `">` + res[i].likes + `人收藏 </p>
                                                    <a href="A03.html?post=`+ res[i].id + `">
                                                        <div class="row card1 border rounded">
                                                            <div class="col left rounded-left ">
                                                                <img src="`+ res[i].image + `">
                                                            </div>
                                                            <div class="col right rounded-right ">
                                                                <h5>`+ category + `收納</h5>
                                                                <h4>`+ title + `</h4>
                                                            </div>
                                                        </div>
                                                    </a>
                                                </div>`
                                            $("#likepost").append(post)

                                            if (res[i].liked == true) {
                                                $("#post" + res[i].id + "").addClass("selectcolor");
                                            }

                                        }
                                    }
                                }
                            })
                        }
                    });
            });
        }

        function lead() {
            $(".lead").css('display', 'none');
            db.transaction(function (tx) {
                tx.executeSql("UPDATE page SET post_page = ? WHERE id = ?", [1, 1]);
            });
        }

        function collection(id) {
            $("#post" + id + "").toggleClass("selectcolor");

            $.ajax({
                headers: {
                    "Authorization": "Token " + user_token + ""
                },
                async: false,
                type: "POST",
                url: "http://140.131.114.157/posts/" + id + "/like",
                error: function (err) {
                    alert(JSON.stringify(err))
                }
            })
            $.ajax({
                headers: {
                    "Authorization": "Token " + user_token + ""
                },
                type: "GET",
                async: false,
                url: "http://140.131.114.157/posts/" + id + "",
                success: function (res) {

                    $("#likes" + id + "").html(res.likes + "人收藏 ");
                    // alert(JSON.stringify(res))
                }
            })

        }

        //跳轉特定頁面應用
        // window.handleOpenURL = function (url) {
        //     alert(url)
        //     location.href = "A04.html";
        //     // window.location.hash = url.slice(7) 
        // }

    </script>
</body>



</html>