<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- 匯入ionicons 字型圖標 -->
    <link type="text/css" rel="stylesheet" href="../www/css/mmenu.css" />
    <link rel="stylesheet" href="css/ionicons.min.css">
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <link rel=stylesheet type="text/css" href="../www/css/H01.css">
    <script type="text/javascript" src="js/jquery.qrcode.min.js"></script>
    <!-- mmenu scripts -->
    <script src="../www/js/mmenu.js"></script>
    <script src="../www/js/mmenu.debugger.js"></script>
    <script type="text/javascript" charset="utf-8" src="cordova.js"></script>
    <title>H01</title>
</head>

<body>

    <div class="loading">
        <div class="maskloading"></div>
        <span class="spinner-border text-light" style="position: fixed;top: 48vh;left: 48vw;" role="status"
            aria-hidden="true"></span>
        <p style="color: white;position: fixed;top: 54vh;left: 47vw;">復原中...</p>

    </div>

    <div class="lead" onclick="lead()">
        <div class="mask"></div>
        <p id="leadcaption" class="caption">點擊可以選擇、新增、<br>編輯、刪除樓層</p>
        <img src="static/tap.png" id="leadarrow" class="arrow">
        <!-- <i class="icon ion-md-arrow-round-back arrow"></i> -->
        <div id="leadknow" class="know">我知道了</div>
    </div>

    <div id="page" class="outer">
        <!-- 導覽列 -->
        <ul class="nav header fixed-top">
            <li class="nav-item two">
                <a class="nav-link active" href="#menu"></a>
            </li>
            <li class="dropdown nav-fill">
                <a id="pnid" class="nav-item dropdown-toggle" data-toggle="dropdown" href="#" role="button"
                    aria-haspopup="true" aria-expanded="false"></a>

                <div class="dropdown-menu  plan1">
                    <!-- <a class="dropdown-item plan1"></a> -->
                    <!-- <a class="dropdown-item">二樓</a>
                    <a class="dropdown-item">三樓</a> -->
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item " data-toggle="modal" data-target="#exampleModalCenter3">新增</a>
                    <a class="dropdown-item " data-toggle="modal" data-target="#exampleModalCenter4" id="pedit"
                        style="display:none;">編輯</a>
                    <a class="dropdown-item " data-toggle="modal" data-target="#exampleModalCenter5" id="pdelete"
                        style="display:none;">刪除</a>
                </div>
            </li>
            <img src="static/qr-scan.png" class="qrscan" onclick="createscan()">
            <!-- <i class="icon ion-md-qr-scanner qrscan"></i> -->
        </ul>
        <nav id="menu">
            <ul>
                <li><a href="../www/H03.html"><i class="icon ion-ios-journal iconmenu"></i> &nbsp;儲存的文章</a></li>
                <li><a href="../www/H04.html"><i class="icon ion-ios-notifications iconmenu"></i> &nbsp;物品提醒</a></li>
                <li><a href="#" onclick="backup()"><i class="icon ion-md-cloud-upload iconmenu"></i> &nbsp;備份&nbsp;<span
                            id="backup"></span></a></li>
                <li><a href="#" onclick="recovery()"><i class="icon ion-md-cloud-download iconmenu"></i> &nbsp;復原</a>
                </li>
                <li><a href="#" onclick="reset()"><i class="icon ion-md-build iconmenu"></i> &nbsp;重設密碼</a></li>
                <li><a href="#" onclick="logout()"><i class="icon ion-ios-log-out iconmenu"></i> &nbsp;登出</a></li>
            </ul>
        </nav>
    </div>

    <!-- 因mmenu的關係代替margin-top:30px; -->
    <div style="height: 30px;"></div>
    <!-- 顯示格局的地方 -->
    <div class="box-wrap">

    </div>
    <!-- QRcode掃描 -->
    <div id="showscan" style="display: none;">
        <i class="icon ion-md-qr-scanner"></i>
    </div>

    <!-- 新增樓層的彈跳視窗 -->

    <div class="modal fade hide bd-example-modal-sm" id="exampleModalCenter3" tabindex="-1" role="dialog"
        aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalCenterTitle">新增樓層</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body ">
                    <form id='pniform'>
                        <label for="exampleInputPassword1">名稱</label>
                        <P id="pniwarn" style="display:inline-flex;color: red;margin:0px;"></P>
                        <input id="insertpname" class="form-control" placeholder="" required>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="insertplanargraph()">確認</button>
                </div>
            </div>

        </div>
    </div>

    <!-- 是否繼續新增樓層互動視窗 -->
    <div class="modal hide fade" id="addpwarn" tabindex="-1" role="dialog" aria-labelledby="addpwarn"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content" style="border-radius: 5%;">
                <div class="modal-body text-black">
                    <p style="font-size: 16px"><span id="existedp" style="font-size: 20px"></span>
                        已經存在，可能會造成混淆，是否繼續以相同名稱創建?</p>
                    <div class="row" style="text-align: center">
                        <div class="col">
                            <button type="button" class="btn btn-outline-secondary" onclick="addpwarnNo()">否</button>
                        </div>
                        <div class="col">
                            <button type="submit" class="btn btn-outline-secondary" onclick="addpwarnYes()">是</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 編輯樓層的彈跳視窗 -->

    <div class="modal fade bd-example-modal-sm" id="exampleModalCenter4" tabindex="-1" role="dialog"
        aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalCenterTitle">編輯樓層</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body ">
                    <form id='pneform'>
                        <label for="exampleInputPassword1">名稱</label>
                        <P id="pnewarn" style="display:inline-flex;color: red;margin:0px;"></P>
                        <input id="editpname" class="form-control" placeholder="" required>
                    </form>
                </div>
                <div class="modal-footer">
                    <!-- <button id="delname" type="button" class="btn"> <i class="ion-md-trash icon3"></i></button> -->
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button id="editPlanargraph" type="button" class="btn btn-primary">確認</button>
                </div>
            </div>

        </div>
    </div>

    <!-- 刪除平面圖 -->
    <div class="modal fade" tabindex="-1" role="dialog" id="exampleModalCenter5" aria-labelledby="exampleModalLabel5"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="margin-top: 50%;border-radius: 5%;">
                <div class="modal-body text-black">
                    <p style="font-size: 16px">是否要刪除<span id="delPname"></span>?</p>
                    <div class="row" style="text-align: center">
                        <div class="col">
                            <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">取消</button>
                        </div>
                        <div class="col">
                            <button id="delPlanargraph" type="button" class="btn btn-outline-secondary">確認</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增格局的彈跳按鈕 -->
    <div class="circlefix add" data-toggle="modal" data-target="#exampleModalCenter2" id="saddbutton"
        style="display:none;">
        <i class="icon ion-md-add"></i>
    </div>
    <!-- 新增格局的彈跳視窗 -->

    <div class="modal fade bd-example-modal-sm" id="exampleModalCenter2" tabindex="-1" role="dialog"
        aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalCenterTitle">新增格局</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body ">
                    <form id='sniform'>
                        <label for="insertsname">名稱</label>
                        <P id="sniwarn" style="display:inline-flex;color: red;margin:0px;"></P>
                        <input id="insertsname" class="form-control" placeholder="" required>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button id="insertspace" type="button" class="btn btn-primary">確認</button>
                </div>
            </div>

        </div>
    </div>


    <!-- 修改格局的彈跳視窗-->
    <div class="modal" id="editSpace" tabindex="-1" role="dialog" aria-labelledby="editSpace" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document"
            style="margin: 0px;position: absolute;bottom:0px; max-width: 1500px;width:100vw">
            <div class="modal-content" style="border-radius: 0%;">
                <div class="modal-body " style="background-color: #254F6E">
                    <div class="row" style="width:100vw;text-align: center">
                        <div class="col-3 icon22">
                            <button onclick="closespace()" class="buttontype" data-toggle="modal"
                                data-target="#editsmodal">
                                <i class="ion-md-create icon2"></i>
                                <p>編輯</p>
                            </button>
                        </div>
                        <div class="col-3 icon22 ">
                            <button onclick="closespace()" class="buttontype" data-toggle="modal"
                                data-target="#delsmodal">
                                <i class=" ion-md-trash icon2"></i>
                                <p>刪除</p>
                            </button>
                        </div>
                        <div class="col-3 icon22">
                            <button id="editscolor" onclick="closespace()" class="buttontype" data-toggle="modal"
                                data-target="#colormodal">
                                <i class=" ion-md-list icon2"></i>
                                <p>顏色</p>
                            </button>
                        </div>
                        <div class="col-3 icon22" style="padding-right: 0px;">
                            <button id="share" onclick="createpdf()" class="buttontype" data-dismiss="modal">
                                <img src="static/qr-code.png" style="margin: 0px;">
                                <p style="width: fit-content;margin-right: 3px;">QR Code</p>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 編輯格局名稱的彈跳視窗 -->

    <div class="modal fade bd-example-modal-sm" id="editsmodal" tabindex="-1" role="dialog" aria-labelledby="editsmodal"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalCenterTitle">編輯格局</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body ">
                    <form id='sneform'>
                        <label for="exampleInputPassword1">名稱</label>
                        <P id="snewarn" style="display:inline-flex;color: red;margin:0px;"></P>
                        <input id="editsnameval" class="form-control" placeholder="" required>
                    </form>
                </div>
                <div class="modal-footer">
                    <!-- <button id="delname" type="button" class="btn"> <i class="ion-md-trash icon3"></i></button> -->
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button id="editsname" type="button" class="btn btn-primary">確認</button>
                </div>
            </div>

        </div>
    </div>

    <!-- 刪除格局 -->
    <div class="modal fade" tabindex="-1" role="dialog" id="delsmodal" aria-labelledby="delsmodal" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="margin-top: 50%;border-radius: 5%;">
                <div class="modal-body text-black">
                    <p style="font-size: 16px">是否要刪除<span id="delsname"></span>?</p>
                    <div class="row" style="text-align: center">
                        <div class="col">
                            <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">取消</button>
                        </div>
                        <div class="col">
                            <button id="delspace" type="button" class="btn btn-outline-secondary">確認</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- 重設密碼互動視窗 -->
    <div class="modal fade " id="resetpassword" tabindex="-1" role="dialog" aria-labelledby="resetpassword"
        aria-hidden="False">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content" style="border-radius: 5%;">
                <div class="modal-header">
                    <h5 class="modal-title">重設密碼</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body text-black" id="resettext">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade bd-example-modal-sm" id="colormodal" tabindex="-1" role="dialog" aria-labelledby="editsmodal"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalCenterTitle">選擇顏色</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body ">
                    <form>
                        <label>顏色</label>
                        <input type="color" id="colorid">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button id="editcolor" type="button" class="btn btn-primary">確認</button>
                </div>
            </div>

        </div>
    </div>

    <!-- 刪除格局 -->
    <div class="modal fade" tabindex="-1" role="dialog" id="recoverymodal" aria-labelledby="recoverymodal"
        aria-hidden="true" data-backdrop="static">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="margin-top: 50%">
                <div class="modal-body text-black">
                    <p style="font-size: 16px">復原完成</p>
                    <div class="row" style="text-align: center">
                        <div class="col">
                            <button type="button" onClick="location.reload()"
                                class="btn btn-outline-secondary">確認</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="container-fluid  footer">
        <div class="row row1 ">
            <div class="col-4 icon">
                <a href="S01.html">
                    <i class="icon ion-md-search icon1"></i>

                </a>
            </div>
            <div class="col-4 icon ">
                <a href="H01.html">
                    <i class="icon ion-md-home icon1" style="color: #254F6E"></i>

                </a>
            </div>
            <div class="col-4 icon">
                <a href="A01.html">
                    <i class="icon ion-md-bookmarks icon1"></i>

                </a>
            </div>

        </div>

    </div>
    <!-- 生成pdf -->
    <div id="spacepdf" style="margin:0px;padding:0px;display:none;">
        <div
            style="background-color: #254F6E;display: -ms-flexbox;display: flex;-ms-flex-wrap: wrap;flex-wrap: wrap;color:white;vertical-align:middle;">
            <h1 style="margin-top: 10px;font-size: 30px;">&emsp; <span id="printp">一樓</span> &emsp;/&ensp; <span
                    id="prints">客廳</span></h1>
        </div>
        <div id="furniturepdf">
            <div id="furnituresqr"
                style="display: -ms-flexbox;display: flex;-ms-flex-wrap: wrap;flex-wrap: wrap;margin-right: -15px;margin-left: -15px;margin-top: 10px;">
                <div style="width: 80%;border: 1px solid black;margin:3% 0 0 6%;">
                    <table border="1px" width="100%" style="border-collapse:collapse;">
                        <tr>
                            <th colspan="2">矮櫃</td>
                            <td rowspan="2" style="width:33%;padding:5px;vertical-align:middle;text-align: center;"><img
                                    src="file:///android_asset/www/static/qr-code-1.png"></td>
                        </tr>
                        <tr>
                            <td><img src="file:///android_asset/www/static/post/01.jpg" width="100%"></td>
                            <td style="width:30%;"></td>
                        </tr>
                    </table>
                </div>


            </div>

        </div>

    </div>

    <script>
        //引導頁
        function lead() {
            $('.lead').attr('onclick', 'lead2()');
            // $(".lead").css('display', 'block');
            $("#leadarrow").removeClass("arrow")
            $("#leadarrow").addClass("arrow2")
            $("#leadcaption").removeClass("caption")
            $("#leadcaption").addClass("caption2")
            $("#leadcaption").html("點擊可以新增格局。")
            $("#leadknow").removeClass("know")
            $("#leadknow").addClass("know2")
        }
        function lead2() {
            $('.lead').attr('onclick', 'lead3()');
            $("#leadarrow").removeClass("arrow2")
            $("#leadarrow").addClass("arrow")
            $(".arrow").css("left", "3px");
            $("#leadcaption").removeClass("caption2")
            $("#leadcaption").addClass("caption")
            $(".caption").css("left", "40px");
            $("#leadcaption").html("點擊進入功能選單:<br>觀看儲存的文章、物品提醒、<br>同步、重設密碼、登出。")
            $("#leadknow").removeClass("know2")
            $("#leadknow").addClass("know")
            $(".know").css("left", "120px");
        }
        function lead4() {
            $('.lead').attr('onclick', 'lead5()');
            $('#leadarrow').removeAttr("style")
            $("#leadarrow").removeClass("arrow");
            $("#leadarrow").addClass("arrow5");
            $(".lead").css('display', 'block');
            $(".caption").css({ "left": "100px", "top": "150px" });
            $("#leadcaption").html("點擊開啟QR Code掃描器，<br>快速查找物品")
            $(".know").css({ "left": "200px", "top": "200px" });
        }
        function lead5() {
            $(".lead").css('display', 'none');
        }

        var user_email;
        var user_token;
        var user_id;


        new Mmenu(document.querySelector('#menu'));

        document.addEventListener('click', (evnt) => {
            let anchor = evnt.target.closest('a[href^="#/"]');
            if (anchor) {
                alert('Thank you for clicking, but that\'s a demo link.');
                evnt.preventDefault();
            }
        });

        document.addEventListener("deviceready", onDeviceReady, false);
        var db;
        function onDeviceReady() {
            db = window.sqlitePlugin.openDatabase({
                name: 'my.db',
                location: 'default',
            });
            //提醒跳轉
            cordova.plugins.notification.local.on("click", function (notification) {
                window.location.href = 'T01_edit.html?thing=' + notification.thingId + ''
            });

            db.transaction(function (tx) {
                tx.executeSql('CREATE TABLE IF NOT EXISTS user (id integer primary key, email text, token text, nickname text)');
                tx.executeSql('CREATE TABLE IF NOT EXISTS planargraph (id text primary key, name text, user_id integer)');
                tx.executeSql('CREATE TABLE IF NOT EXISTS space (id text primary key, name text, space_color text, planargraph_id text)');
                tx.executeSql('CREATE TABLE IF NOT EXISTS thing (id text primary key, name text, description text, image text, category text, owner text, furniture_id text, number integer, layer text, out integer, remind integer, time date, content text)');
                tx.executeSql('CREATE TABLE IF NOT EXISTS furniture (id text primary key, name text, image text, layer text, space_id text)');
                tx.executeSql('CREATE TABLE IF NOT EXISTS page (id integer primary key, home integer, furniture_page integer, search_page integer, post_page integer)');
            });


            db.transaction(function (tx) {
                tx.executeSql('SELECT * FROM user', [],
                    function (tx, res) {
                        var len = res.rows.length;
                        if (res.rows.length >= 1) {
                            user_email = res.rows.item(0)['email']
                            user_token = res.rows.item(0)['token']
                            user_id = res.rows.item(0)['id']


                            $(".mm-navbar__title").html("Hi~" + " " + res.rows.item(0)['nickname']);
                            $(".mm-navbar__title").css({ "background-color": "#254F6E", "color": "white" });
                            tx.executeSql("SELECT * FROM planargraph WHERE user_id = ?", [res.rows.item(0)['id']], function (tx, res) {
                                var len = res.rows.length;

                                if (res.rows.length >= 1) {
                                    for (var i = 0; i < len; i++) {
                                        $(".plan1").prepend(`<a class="dropdown-item" onclick="pnidclick('` + res.rows.item(i)['id'] + `')">` + res.rows.item(i)['name'] + `</a>`)
                                    }
                                    $("#pedit").css('display', 'block');
                                    $("#pdelete").css('display', 'block');
                                    $("#saddbutton").css('display', 'block');
                                    let urlParams = new URLSearchParams(window.location.search);
                                    // alert(urlParams)
                                    var planargraphId = urlParams.get('planargraph');
                                    if (!planargraphId) {
                                        pnidclick(res.rows.item(0)['id'])
                                    } else {
                                        pnidclick(planargraphId)

                                    }
                                    tx.executeSql("SELECT * FROM page", [],
                                        function (tx, res) {
                                            var len = res.rows.length;
                                            if (res.rows.length >= 1) {
                                                var home = res.rows.item(0)['home']
                                                if (!home) {
                                                    $(".lead").css('display', 'block');
                                                }
                                            }
                                        });
                                } else {
                                    var timestamp = (new Date()).valueOf();
                                    var email = user_email.replace(/@/g, "").split(".").join("");
                                    var planargraphId = email + timestamp;
                                    tx.executeSql('INSERT INTO planargraph (id, name, user_id) VALUES (?,?,?)', [planargraphId, "一樓", user_id],
                                        function (tx, res) {
                                            location.href = "H01.html?planargraph=" + planargraphId + "";
                                        });

                                }
                            });
                            // qrcode 掃描跳轉 homeset://
                            window.handleOpenURL = function (url) {
                                var open = url.split("/")[2]
                                var spaceId = open.split("=")[1].slice(0, 13)
                                var furnitureId = open.split("=")[2].slice(0, 13)
                                var email = user_email.replace(/@/g, "").split(".").join("");
                                location.replace("F01.html?space=" + email + spaceId + "&furniture=" + email + furnitureId + "");
                                // window.location.hash = url.slice(7) 
                            }
                        }
                    }, function (error) {
                        alert(JSON.stringify(error))
                    });


            });
        }

        function lead3() {
            $(".lead").css('display', 'none');
            db.transaction(function (tx) {
                tx.executeSql("UPDATE page SET home = ? WHERE id = ?", [1, 1], function (tx, res) {
                    location.reload()
                });
            });
        }

        // 生成pdf base64
        function createpdf() {

            let options = {
                documentSize: 'A4',
                type: 'base64'
            }
            var spacepdf = $("#spacepdf").html()
            pdf.fromData(spacepdf, options)
                .then((base64) => furnitureshare(base64))   // returns base64:JVBERi0xLjQKJdPr6eEKMSAwIG9iago8PC9DcmVh...
                .catch((err) => alert(err))
        }

        //分享
        function furnitureshare(name) {
            var snamepdf = $("#prints").html()

            var options = {
                message: snamepdf, // not supported on some apps (Facebook, Instagram)
                subject: snamepdf, // fi. for email
                files: ['data:application/pdf;base64,' + name + ''], // an array of filenames either locally or remotely
                // url: 'https://www.website.com/foo/#bar?a=b',
                //chooserTitle: 'Pick an app', // Android only, you can override the default share sheet title
                //appPackageName: 'com.apple.social.facebook', // Android only, you can provide id of the App you want to share with
                //iPadCoordinates: '0,0,0,0' //IOS only iPadCoordinates for where the popover should be point.  Format with x,y,width,height
            };

            var onSuccess = function (result) {
                //alert("Share completed? " + result.completed); // On Android apps mostly return false even while it's true
                //alert("Shared to app: " + result.app); // On Android result.app since plugin version 5.4.0 this is no longer empty. On iOS it's empty when sharing is cancelled (result.completed=false)
            };

            var onError = function (msg) {
                alert("Sharing failed with message: " + msg);
            };

            window.plugins.socialsharing.shareWithOptions(options, onSuccess, onError);
        }




        // 更改點擊選單中的平面圖
        // pnid為標題顯示文字
        // editpname 為編輯輸入框
        //editPlanargraph 為編輯平面圖名稱的確認鍵
        //delPlanargraph  為編刪除平面圖的確認鍵
        //insertspace 新增格局
        function pnidclick(id) {
            db.transaction(function (tx) {
                tx.executeSql('SELECT * FROM planargraph WHERE id = ?', [id],
                    function (tx, res) {
                        $("#pnid").html(res.rows.item(0)['name'])
                        $("#editpname").val(res.rows.item(0)['name'])
                        $("#delPname").html(res.rows.item(0)['name'])
                        $("#printp").html(res.rows.item(0)['name'])
                    });
            });
            $('#insertspace').attr('onclick', 'insertspace("' + id + '")');
            $('#editPlanargraph').attr('onclick', 'editplanargraph("' + id + '")');
            $('#delPlanargraph').attr('onclick', 'delPlanargraph("' + id + '")');

            //呈現格局
            db.transaction(function (tx) {
                tx.executeSql('SELECT * FROM space WHERE planargraph_id = ?', [id],
                    function (tx, res) {
                        $(".box-wrap").html("")
                        var len = res.rows.length;
                        if (res.rows.length >= 1) {
                            for (var i = 0; i < len; i++) {
                                $(".box-wrap").append(`<div style="background-color:` + res.rows.item(i)['space_color'] + `;" class="box">
                                                        <i id="spacemore" onclick='spacemore("`+ res.rows.item(i)['id'] + `")' class='icon ion-md-more imore'></i>
                                                        <a href="F01.html?space=`+ res.rows.item(i)['id'] + `"><span id="sname` + res.rows.item(i)['id'] + `" style="color: white;text-shadow: 0 0 0.2em rgba(32, 31, 31, 0.568);">` + res.rows.item(i)['name'] + `</span></a>
                                                        </div>`)
                            }

                            // 格局
                            tx.executeSql("SELECT * FROM page", [],
                                function (tx, res) {
                                    var len = res.rows.length;
                                    if (res.rows.length >= 1) {
                                        var home = res.rows.item(0)['home']
                                        if (home == 1) {
                                            $('.lead').attr('onclick', 'lead4()');
                                            $(".lead").css('display', 'block');
                                            $(".arrow").css({ "left": "115px", "top": "160px" });
                                            $(".caption").css({ "left": "60px", "top": "250px" });
                                            $("#leadcaption").html("點擊可以<br>編輯、刪除、更改顏色<br>以及生成格局內儲物櫃QR Code")
                                            $(".know").css({ "left": "200px", "top": "340px" });
                                            tx.executeSql("UPDATE page SET home = ? WHERE id = ?", [2, 1]);
                                        }
                                    }
                                });
                        }
                    });
            });

        }
        //關閉修改格局(編輯 刪除 顏色)互動視窗
        function closespace() {
            $("#editSpace").modal('hide');
        }
        //點選格局三個點點
        function spacemore(spaceId) {
            $("#editSpace").modal('show');
            $("#furnituresqr").html('');

            db.transaction(function (tx) {
                tx.executeSql('SELECT * FROM space WHERE id = ?', [spaceId],
                    function (tx, res) {
                        $("#editsnameval").val(res.rows.item(0)['name'])
                        $("#delsname").html(res.rows.item(0)['name'])
                        $("#prints").html(res.rows.item(0)['name'])
                        if (!res.rows.item(0)['space_color']) {
                            $("#colorid").val("#047e7e")
                        } else {
                            $("#colorid").val(res.rows.item(0)['space_color'])
                        }
                    });
                tx.executeSql('SELECT * FROM furniture WHERE space_id = ?', [spaceId],
                    function (tx, res) {
                        var len = res.rows.length;
                        if (res.rows.length >= 1) {
                            var spaceId1 = spaceId.slice(-13)


                            for (var i = 0; i < len; i++) {
                                var furnitureId1 = res.rows.item(i)['id'].slice(-13)
                                var printcontent = `
                                <div style="width: 100%;margin:2% 0 0 6%;">
                                    <table border="1px" width="400px" style="border-collapse:collapse;">
                                        <tr>
                                            <th colspan="2">`+ res.rows.item(i)['name'] + `</td>
                                            <td rowspan="2" id="f`+ res.rows.item(i)['id'] + `" style="width:33%;padding:10px;">
                                               </td>
                                        </tr>
                                        <tr>
                                            <td style="width: 33%;vertical-align:middle;text-align: center;"><img src="`+ res.rows.item(i)['image'] + `" height="100px" width="100px"></td>
                                            <td style="width: 33%;"></td>
                                        </tr>
                                    </table>
                                </div>
                                `
                                $("#furnituresqr").append(printcontent);
                                $('#f' + res.rows.item(i)['id'] + '').qrcode({
                                    render: 'table',
                                    width: 120,
                                    height: 120,
                                    text: 'homeset://F01.html?s=' + spaceId1 + '&f=' + furnitureId1 + ''
                                });
                            }
                        }
                    });
            });
            $('#editsname').attr('onclick', 'editsname("' + spaceId + '")');
            $('#delspace').attr('onclick', 'delspace("' + spaceId + '")');
            $('#editcolor').attr('onclick', 'editcolor("' + spaceId + '")');

        }

        //修改顏色
        function editcolor(id) {
            var spacecolor = $("#colorid").val();
            db.transaction(function (tx) {
                tx.executeSql('SELECT * FROM space WHERE id = ?', [id],
                    function (tx, res) {
                        var planargraphId = res.rows.item(0)['planargraph_id']
                        tx.executeSql("UPDATE space SET space_color = ? WHERE id = ?", [spacecolor, id],
                            function (tx, res) {
                                location.href = "H01.html?planargraph=" + planargraphId + "";
                            });
                    });
            });
        }

        //修改格局
        function editsname(id) {
            var name = $("#editsnameval").val();
            if (!name) {
                $('#snewarn').html('<i class="icon ion-md-information-circle"></i>');
                $('#snewarn').append("請輸入格局名稱");
                $('#sneform').addClass("was-validated");
                return
            }
            db.transaction(function (tx) {
                var query = "UPDATE space SET name = ? WHERE id = ?";
                tx.executeSql(query, [name, id], function (tx, res) {
                    $("#editsmodal").modal('hide');
                    $("#sname" + id + "").html(name);
                });
            });

        }


        //修改平面圖
        function editplanargraph(id) {
            var name = $("#editpname").val();
            if (!name) {
                $('#pnewarn').html('<i class="icon ion-md-information-circle"></i>');
                $('#pnewarn').append("請輸入樓層名稱");
                $('#pneform').addClass("was-validated");
                return
            }
            db.transaction(function (tx) {
                var query = "UPDATE planargraph SET name = ? WHERE id = ?";
                tx.executeSql(query, [name, id], function (tx, res) {
                    $("#exampleModalCenter4").modal('hide');
                    location.href = "H01.html?planargraph=" + id + "";
                });
            });

        }

        // 刪除格局
        function delspace(id) {
            var planargraphId
            db.transaction(function (tx) {
                tx.executeSql('SELECT * FROM space WHERE id = ?', [id],
                    function (tx, res) {
                        planargraphId = res.rows.item(0)['planargraph_id']
                        tx.executeSql("SELECT * FROM furniture WHERE space_id = ?", [id], function (tx, res) {
                            var len = res.rows.length;
                            if (res.rows.length >= 1) {
                                for (var j = 0; j < len; j++) {
                                    var trans = function (j) {
                                        tx.executeSql("DELETE FROM thing WHERE furniture_id = ?", [res.rows.item(j)['id']]);
                                    }(j);
                                }
                                tx.executeSql("DELETE FROM furniture WHERE space_id = ?", [id], function (tx, res) {
                                    tx.executeSql("DELETE FROM space WHERE id = ?", [id], function (tx, res) {
                                        location.href = "H01.html?planargraph=" + planargraphId + "";
                                    });
                                });
                            } else {
                                tx.executeSql("DELETE FROM space WHERE id = ?", [id], function (tx, res) {
                                    location.href = "H01.html?planargraph=" + planargraphId + "";
                                });
                            }
                        });
                    });
            });
        }


        // 刪除平面圖
        function delPlanargraph(id) {
            db.transaction(function (tx) {
                tx.executeSql("SELECT * FROM space WHERE planargraph_id = ?", [id], function (tx, res) {
                    var len = res.rows.length;
                    if (res.rows.length >= 1) {
                        for (var i = 0; i < len; i++) {
                            var tran = function (i) {
                                var spaceId = res.rows.item(i)['id']
                                tx.executeSql("SELECT * FROM furniture WHERE space_id = ?", [spaceId], function (tx, res) {
                                    var len = res.rows.length;
                                    if (res.rows.length >= 1) {
                                        for (var j = 0; j < len; j++) {
                                            var trans = function (j) {
                                                tx.executeSql("DELETE FROM thing where furniture_id = ?", [res.rows.item(j)['id']]);
                                            }(j);
                                        }
                                        tx.executeSql("DELETE FROM furniture where space_id = ?", [spaceId], function (tx, res) {
                                            tx.executeSql("DELETE FROM space WHERE planargraph_id = ?", [id], function (tx, res) {
                                                tx.executeSql("DELETE FROM planargraph WHERE id = ?", [id], function (tx, res) {
                                                    location.href = "H01.html"
                                                });
                                            });
                                        });
                                    } else {
                                        tx.executeSql("DELETE FROM space WHERE planargraph_id = ?", [id], function (tx, res) {
                                            tx.executeSql("DELETE FROM planargraph WHERE id = ?", [id], function (tx, res) {
                                                location.href = "H01.html"
                                            });
                                        });
                                    }
                                });

                            }(i);
                        }
                    } else {
                        tx.executeSql("DELETE FROM planargraph WHERE id = ?", [id], function (tx, res) {
                            location.href = "H01.html"
                        });
                    }
                });
            });
        }


        // 新增平面圖(預設一樓))
        //exampleModalCenter3 新增樓層的彈跳視窗
        //insertpname 新增樓層的輸入框
        //要抓到目前登入使用者的帳號
        function insertplanargraph() {
            db.transaction(function (tx) {
                var timestamp = (new Date()).valueOf();
                // alert("timestamp"+timestamp);
                var email = user_email.replace(/@/g, "").split(".").join("");
                var planargraphId = email + timestamp;
                var name = $("#insertpname").val();
                if (!name) {
                    $('#pniwarn').html('<i class="icon ion-md-information-circle"></i>');
                    $('#pniwarn').append("請輸入樓層名稱");
                    $('#pniform').addClass("was-validated");
                    return
                }
                tx.executeSql('SELECT * FROM planargraph WHERE user_id = ?', [user_id],
                    function (tx, res) {
                        var len = res.rows.length;
                        if (res.rows.length >= 1) {
                            for (var i = 0; i < len; i++) {
                                $('#exampleModalCenter3').modal('hide')
                                if (name == res.rows.item(i)['name']) {

                                    $("#existedp").html(name)
                                    $('#addpwarn').modal('show')
                                    return false;
                                }

                            }

                        }
                        tx.executeSql('INSERT INTO planargraph (id, name, user_id) VALUES (?,?,?)', [planargraphId, name, user_id],
                            function (tx, res) {
                                $('#exampleModalCenter3').modal('hide')
                                $("#insertpname").val("");
                                location.href = "H01.html?planargraph=" + planargraphId + "";
                            }, function (error) {
                                alert('Something went Wrong');
                            });
                    }, function (error) {
                        alert('Something went Wrong');
                        alert(JSON.stringify(error));
                    });


            });
        }
        // 是否繼續新增樓層互動視窗
        function addpwarnNo() {
            $('#addpwarn').modal('hide')
            $('#exampleModalCenter3').modal('show')
        }
        // 是否繼續新增樓層互動視窗
        function addpwarnYes() {
            $('#addpwarn').modal('hide')
            db.transaction(function (tx) {
                var timestamp = (new Date()).valueOf();
                var email = user_email.replace(/@/g, "").split(".").join("");
                var planargraphId = email + timestamp;
                var name = $("#insertpname").val();
                tx.executeSql('INSERT INTO planargraph (id, name, user_id) VALUES (?,?,?)', [planargraphId, name, user_id],
                    function (tx, res) {
                        $('#exampleModalCenter3').modal('hide')
                        $("#insertpname").val("");
                        location.href = "H01.html?planargraph=" + planargraphId + "";
                    }, function (error) {
                        alert('Something went Wrong');
                    });
            });

        }


        // 新增格局

        function insertspace(planargraphId) {

            db.transaction(function (tx) {
                var timestamp = (new Date()).valueOf();
                // alert("timestamp"+timestamp);
                var email = user_email.replace(/@/g, "").split(".").join("")
                var spaceId = email + timestamp;
                var name = $("#insertsname").val();
                if (!name) {
                    $('#sniwarn').html('<i class="icon ion-md-information-circle"></i>');
                    $('#sniwarn').append("請輸入格局名稱");
                    $('#sniform').addClass("was-validated");
                    return
                }

                tx.executeSql('INSERT INTO space (id, name, planargraph_id) VALUES (?,?,?)', [spaceId, name, planargraphId],
                    function (tx, res) {
                        $('#exampleModalCenter2').modal('hide')
                        $("#insertsname").val("");
                        location.href = "H01.html?planargraph=" + planargraphId + "";
                    }, function (error) {
                        alert('Something went Wrong');
                    });
            });
        }

        // 重設密碼
        function reset() {
            // $('#menu1').click();
            $("html").removeClass("mm-wrapper_opening")
            $("#resetpassword").modal("show")
            $.ajax({
                type: "POST",
                url: "http://140.131.114.157/users/password_reset",
                data: {
                    "email": user_email
                },
                error: function (err) {
                    alert(err)
                },
                success: function (res) {
                    $("#resettext").html(`<p style="font-size:18px;"><b>變更密碼確認信已送出</b></p>
                                 <p>為了確保會員切身的權益，我們已經寄發確認信到 <span style="font-size:18px;"> `+ user_email + `</span>。</p>
                                 <p>請在24小時內至該信箱收取確認信，並重新設定密碼。</p>`)
                    $("#resetpassword").modal("show")
                }
            })
        }

        function logout() {
            db.transaction(function (tx) {
                tx.executeSql('DROP TABLE IF EXISTS user', [], function (tx, res) {
                    location.href = 'index.html'
                });
            });
        }

        //QRcode掃描器
        function createscan() {

            var callback = function (err, contents) {
                if (err) {
                    alert.error(err._message);
                }
                window.open(contents, '_system')

            };

            QRScanner.scan(callback);
            QRScanner.show(function (status) {
                $(".box-wrap").css('display', 'none');
                $("#saddbutton").css('display', 'none');
                $("#showscan").css('display', 'block');

            });

        }

        // 備份
        function uploadthing(furniture_id) {

            db.transaction(function (tx) {
                tx.executeSql('SELECT * FROM thing WHERE furniture_id = ?', [furniture_id],
                    function (tx, res) {
                        var len = res.rows.length

                        if (res.rows.length >= 1) {
                            for (var i = 0; i < len; i++) {
                                $("#backup").html(` <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" ></span>
                    <span style="font-size: 12px;">備份中...</span>
                  `);
                                var tid = res.rows.item(i)['id'];

                                var tname = res.rows.item(i)['name'];
                                if (!tname) {
                                    tname = ""
                                }
                                var tdescription = res.rows.item(i)['description'];
                                if (!tname) {
                                    tdescription = ""
                                }
                                var timage = res.rows.item(i)['image'];
                                var tcategory = res.rows.item(i)['category'];
                                if (!tcategory) {
                                    tcategory = ""
                                }
                                var towner = res.rows.item(i)['owner'];
                                if (!towner) {
                                    towner = ""
                                }
                                var tnumber = res.rows.item(i)['number'];
                                if (!tnumber) {
                                    tnumber = ""
                                }
                                var tlayer = res.rows.item(i)['layer'];
                                if (!tlayer) {
                                    tlayer = ""
                                }
                                var tout = res.rows.item(i)['out'];
                                if (!tout) {
                                    tout = ""
                                }
                                var tremind = res.rows.item(i)['remind'];
                                if (!tremind) {
                                    tremind = ""
                                }
                                var ttime = res.rows.item(i)['time'];

                                if (!ttime) {
                                    ttime = ""
                                }
                                var tcontent = res.rows.item(i)['content'];
                                if (!tcontent) {
                                    tcontent = ""
                                }

                                var judge = timage.split(":")[0]
                                // alert(judge)
                                if (judge == "http") {
                                    $.ajax({
                                        type: "POST",
                                        headers: {
                                            "Authorization": "Token " + user_token + ""
                                        },
                                        async: false,
                                        url: "http://140.131.114.157/things",
                                        data: {
                                            "id": tid,
                                            "name": tname,
                                            "description": tdescription,
                                            "category": tcategory,
                                            "owner": towner,
                                            "number": tnumber,
                                            "layer": tlayer,
                                            "out": tout,
                                            "remind": tremind,
                                            "time": ttime,
                                            "content": tcontent,
                                            "furniture_id": furniture_id,
                                            "url": timage
                                        },
                                        error: function (err) {
                                            alert(JSON.stringify(err));
                                        },
                                        success: function (res) {
                                            // alert(JSON.stringify(res));
                                            var Today = new Date();
                                            $("#backup").html("上次備份 : " + Today.getFullYear() + " 年 " + (Today.getMonth() + 1) + " 月 " + Today.getDate() + " 日 ");

                                        }
                                    })

                                } else {
                                    let options = new FileUploadOptions();
                                    options.fileKey = "image";
                                    let point = timage.lastIndexOf(".");
                                    let type = timage.substr(point);
                                    let headers = { "Authorization": "Token " + user_token + "" };
                                    options.headers = headers;
                                    //上传附带参数
                                    var params = {};
                                    params.type = type;
                                    params.id = tid;
                                    params.name = tname;
                                    params.description = tdescription;
                                    params.category = tcategory;
                                    params.owner = towner;
                                    params.number = tnumber;
                                    params.layer = tlayer;
                                    params.out = tout;
                                    params.remind = tremind;
                                    params.time = ttime;
                                    params.content = tcontent;
                                    params.furniture_id = furniture_id;

                                    //设置参数，后台获取
                                    options.params = params;
                                    options.httpMethod = "POST";
                                    let ft = new FileTransfer();
                                    ft.upload(timage, encodeURI("http://140.131.114.157/things"), onSuccess, onError, options);
                                    function onSuccess(r) {
                                        // alert("upload onSuccess " + JSON.stringify(r));
                                        var Today = new Date();
                                        $("#backup").html("上次備份 : " + Today.getFullYear() + " 年 " + (Today.getMonth() + 1) + " 月 " + Today.getDate() + " 日 ");
                                    }

                                    function onError(error) {
                                        alert("upload error target " + JSON.stringify(error));
                                    }
                                }
                            }
                        } else {
                            var Today = new Date();
                            $("#backup").html("上次備份 : " + Today.getFullYear() + " 年 " + (Today.getMonth() + 1) + " 月 " + Today.getDate() + " 日 ");
                        }
                    });
            });
        }


        function uploadfurniture(space_id) {
            db.transaction(function (tx) {
                tx.executeSql('SELECT * FROM furniture WHERE space_id = ?', [space_id],
                    function (tx, res) {
                        var len = res.rows.length
                        if (res.rows.length >= 1) {
                            for (var i = 0; i < len; i++) {
                                $("#backup").html(` <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" ></span>
                    <span style="font-size: 12px;">備份中...</span>
                  `);
                                var fid = res.rows.item(i)['id'];
                                var fname = res.rows.item(i)['name'];
                                var flayer = res.rows.item(i)['layer'];
                                var fimage = res.rows.item(i)['image'];
                                var judge = fimage.split(":")[0]
                                // alert(judge)
                                if (judge == "http") {
                                    $.ajax({
                                        type: "POST",
                                        headers: {
                                            "Authorization": "Token " + user_token + ""
                                        },
                                        async: false,
                                        url: "http://140.131.114.157/furnitures",
                                        data: {
                                            "id": fid,
                                            "name": fname,
                                            "layer": flayer,
                                            "space_id": space_id,
                                            "url": fimage
                                        },
                                        error: function (err) {
                                            alert(JSON.stringify(err));
                                        },
                                        success: function (res) {
                                            // alert(JSON.stringify(res));
                                            var Today = new Date();
                                            $("#backup").html("上次備份 : " + Today.getFullYear() + " 年 " + (Today.getMonth() + 1) + " 月 " + Today.getDate() + " 日 ");
                                            // alert(fid)
                                            uploadthing(fid)
                                        }
                                    })
                                } else {
                                    let options = new FileUploadOptions();
                                    options.fileKey = "image";
                                    let point = fimage.lastIndexOf(".");
                                    let type = fimage.substr(point);
                                    let headers = { "Authorization": "Token " + user_token + "" };
                                    options.headers = headers;
                                    //上传附带参数
                                    var params = {};
                                    params.type = type;
                                    params.id = fid;
                                    params.name = fname;
                                    params.layer = flayer;
                                    params.space_id = space_id;
                                    //设置参数，后台获取
                                    options.params = params;
                                    options.httpMethod = "POST";
                                    let ft = new FileTransfer();
                                    ft.upload(fimage, encodeURI("http://140.131.114.157/furnitures"), onSuccess, onError, options);
                                    function onSuccess(r) {
                                        // alert("upload onSuccess " + JSON.stringify(r));
                                        var obj = JSON.parse(r.response)
                                        uploadthing(obj.id);
                                        var Today = new Date();
                                        $("#backup").html("上次備份 : " + Today.getFullYear() + " 年 " + (Today.getMonth() + 1) + " 月 " + Today.getDate() + " 日 ");
                                    }

                                    function onError(error) {
                                        alert("upload error target " + JSON.stringify(error));
                                    }
                                }
                            }
                        } else {
                            var Today = new Date();
                            $("#backup").html("上次備份 : " + Today.getFullYear() + " 年 " + (Today.getMonth() + 1) + " 月 " + Today.getDate() + " 日 ");
                        }
                    });
            });
        }

        function uploadspace(planargraph_id) {
            db.transaction(function (tx) {
                tx.executeSql('SELECT * FROM space WHERE planargraph_id = ?', [planargraph_id],
                    function (tx, res) {
                        var len = res.rows.length
                        if (res.rows.length >= 1) {
                            for (var i = 0; i < len; i++) {
                                $("#backup").html(` <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" ></span>
                    <span style="font-size: 12px;">備份中...</span>
                  `);
                                var sid = res.rows.item(i)['id'];
                                var sname = res.rows.item(i)['name'];
                                var scolor = res.rows.item(i)['space_color'];
                                $.ajax({
                                    type: "POST",
                                    headers: {
                                        "Authorization": "Token " + user_token + ""
                                    },
                                    async: false,
                                    url: "http://140.131.114.157/spaces",
                                    data: {
                                        "id": sid,
                                        "name": sname,
                                        "space_color": scolor,
                                        "planargraph_id": planargraph_id
                                    },
                                    error: function (err) {
                                        alert(JSON.stringify(err));
                                    },
                                    success: function (res) {
                                        // alert(JSON.stringify(res));
                                        var Today = new Date();
                                        $("#backup").html("上次備份 : " + Today.getFullYear() + " 年 " + (Today.getMonth() + 1) + " 月 " + Today.getDate() + " 日 ");
                                        uploadfurniture(sid)
                                    }
                                })
                            }
                        } else {
                            var Today = new Date();
                            $("#backup").html("上次備份 : " + Today.getFullYear() + " 年 " + (Today.getMonth() + 1) + " 月 " + Today.getDate() + " 日 ");
                        }
                    });
            });
        }


        function backup() {
            $("#backup").html(` <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" ></span>
                    <span style="font-size: 12px;">備份中...</span>
                  `);
            $.ajax({
                type: "DELETE",
                headers: {
                    "Authorization": "Token " + user_token + ""
                },
                async: false,
                url: "http://140.131.114.157/planargraphs/my",
                error: function (err) {
                    alert(JSON.stringify(err));
                },
                success: function (res) {
                    // alert(JSON.stringify(res));
                }
            })
            db.transaction(function (tx) {
                tx.executeSql('SELECT * FROM planargraph WHERE user_id = ?', [user_id],
                    function (tx, res) {
                        var len = res.rows.length
                        if (res.rows.length >= 1) {
                            for (var i = 0; i < len; i++) {
                                var pid = res.rows.item(i)['id'];
                                var pname = res.rows.item(i)['name'];
                                $.ajax({
                                    type: "POST",
                                    headers: {
                                        "Authorization": "Token " + user_token + ""
                                    },
                                    async: false,
                                    url: "http://140.131.114.157/planargraphs",
                                    data: {
                                        "id": pid,
                                        "name": pname,
                                        "user_id": user_id
                                    },
                                    error: function (err) {
                                        alert(JSON.stringify(err));
                                    },
                                    success: function (res) {
                                        // alert(JSON.stringify(res));
                                        var Today = new Date();
                                        $("#backup").html("上次備份 : " + Today.getFullYear() + " 年 " + (Today.getMonth() + 1) + " 月 " + Today.getDate() + " 日 ");
                                        uploadspace(pid)
                                    }
                                })
                            }
                        } else {
                            var Today = new Date();
                            $("#backup").html("上次備份 : " + Today.getFullYear() + " 年 " + (Today.getMonth() + 1) + " 月 " + Today.getDate() + " 日 ");
                        }
                    });
            });
        }


        //還原

        function downloadthing(furniture_id) {
            db.transaction(function (tx) {
                $.ajax({
                    type: "GET",
                    headers: {
                        "Authorization": "Token " + user_token + ""
                    },
                    async: false,
                    url: "http://140.131.114.157/things/own/" + furniture_id + "",
                    error: function (err) {
                        alert(JSON.stringify(err));
                    },
                    success: function (res) {
                        // alert(JSON.stringify(res));
                        // alert(res.length);
                        // alert(res[0].id);
                        var len = res.length
                        if (len >= 1) {
                            for (var i = 0; i < len; i++) {

                                if (!res[i].url) {
                                    // alert("image")
                                    tx.executeSql('INSERT INTO thing (id, name, description, image, category, owner, furniture_id, number, layer, out, remind, time, content) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?)', [res[i].id, res[i].name, res[i].description, res[i].image, res[i].category, res[i].owner, res[i].furniture_id, res[i].number, res[i].layer, res[i].out, res[i].remind, res[i].time, res[i].content]);
                                } else {
                                    // alert("url")
                                    tx.executeSql('INSERT INTO thing (id, name, description, image, category, owner, furniture_id, number, layer, out, remind, time, content) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?)', [res[i].id, res[i].name, res[i].description, res[i].url, res[i].category, res[i].owner, res[i].furniture_id, res[i].number, res[i].layer, res[i].out, res[i].remind, res[i].time, res[i].content]);
                                }
                            }
                        }
                    }
                });
            });
        }

        function downloadfurniture(space_id) {
            db.transaction(function (tx) {
                $.ajax({
                    type: "GET",
                    headers: {
                        "Authorization": "Token " + user_token + ""
                    },
                    async: false,
                    url: "http://140.131.114.157/furnitures/own/" + space_id + "",
                    error: function (err) {
                        alert(JSON.stringify(err));
                    },
                    success: function (res) {
                        // alert(JSON.stringify(res));
                        // alert(res.length);
                        // alert(res[0].id);
                        var len = res.length
                        if (len >= 1) {
                            for (var i = 0; i < len; i++) {
                                downloadthing(res[i].id);
                                if (!res[i].url) {
                                    tx.executeSql('INSERT INTO furniture (id, name, image, layer, space_id) VALUES (?,?,?,?,?)', [res[i].id, res[i].name, res[i].image, res[i].layer, res[i].space_id]);
                                } else {
                                    tx.executeSql('INSERT INTO furniture (id, name, image, layer, space_id) VALUES (?,?,?,?,?)', [res[i].id, res[i].name, res[i].url, res[i].layer, res[i].space_id]);
                                }
                            }
                        }
                    }
                });
            });
        }


        function downloadspace(planargraph_id) {
            db.transaction(function (tx) {
                $.ajax({
                    type: "GET",
                    headers: {
                        "Authorization": "Token " + user_token + ""
                    },
                    async: false,
                    url: "http://140.131.114.157/spaces/own/" + planargraph_id + "",
                    error: function (err) {
                        alert(JSON.stringify(err));
                    },
                    success: function (res) {
                        // alert(JSON.stringify(res));
                        // alert(res.length);
                        // alert(res[0].id);
                        var len = res.length
                        if (len >= 1) {
                            for (var i = 0; i < len; i++) {
                                downloadfurniture(res[i].id);
                                tx.executeSql('INSERT INTO space (id, name, space_color, planargraph_id) VALUES (?,?,?,?)', [res[i].id, res[i].name, res[i].space_color, res[i].planargraph_id]);
                            }
                        }
                    }
                });
            });
        }


        function recovery() {
            $(".loading").css('display', 'block');
            $("html").removeClass("mm-wrapper_opening")
            setTimeout(recoveryend, 5000);
            db.transaction(function (tx) {
                tx.executeSql('DROP TABLE IF EXISTS planargraph');
                tx.executeSql('DROP TABLE IF EXISTS space');
                tx.executeSql('DROP TABLE IF EXISTS furniture');
                tx.executeSql('DROP TABLE IF EXISTS thing');
                tx.executeSql('CREATE TABLE IF NOT EXISTS planargraph (id text primary key, name text, user_id integer)');
                tx.executeSql('CREATE TABLE IF NOT EXISTS space (id text primary key, name text, space_color text, planargraph_id text)');
                tx.executeSql('CREATE TABLE IF NOT EXISTS thing (id text primary key, name text, description text, image text, category text, owner text, furniture_id text, number integer, layer text, out integer, remind integer, time date, content text)');
                tx.executeSql('CREATE TABLE IF NOT EXISTS furniture (id text primary key, name text, image text, layer text, space_id text)');

                $.ajax({
                    type: "GET",
                    headers: {
                        "Authorization": "Token " + user_token + ""
                    },
                    async: false,
                    url: "http://140.131.114.157/planargraphs/own",
                    error: function (err) {
                        alert(JSON.stringify(err));
                    },
                    success: function (res) {
                        // alert(JSON.stringify(res));
                        var len = res.length
                        if (len >= 1) {
                            for (var i = 0; i < len; i++) {
                                downloadspace(res[i].id);
                                tx.executeSql('INSERT INTO planargraph (id, name, user_id) VALUES (?,?,?)', [res[i].id, res[i].name, res[i].user_id]);

                            }
                        }
                    }
                })


            });
        }

        function recoveryend() {
            $(".loading").css('display', 'none');
            $("#recoverymodal").modal('show');

        }


        //完整代码：
        function uploadFile(fileurl, name) {
            let options = new FileUploadOptions();
            options.fileKey = "image";
            let point = fileurl.lastIndexOf(".");
            let type = fileurl.substr(point);
            let headers = { "Authorization": "Token " + user_token + "" };
            options.headers = headers;
            //上传附带参数
            var params = {};
            params.type = type;
            params.title = "eee";
            params.content = "typeeeeee";
            //设置参数，后台获取
            options.params = params;
            options.httpMethod = "POST";
            let ft = new FileTransfer();
            ft.upload(fileurl, encodeURI("http://140.131.114.157/posts"), onSuccess, onError, options);
            function onSuccess(r) {
                alert("Code = " + r.responseCode);
                alert("Response = " + r.response);
                alert("Sent = " + r.bytesSent);
                alert("upload onSuccess " + JSON.stringify(r));
                uploadhelp(r.response, type);
            }

            function onError(error) {
                alert("An error has occurred: Code = " + error.code);
                alert("upload error source " + error.source);
                alert("upload error target " + error.target);
                alert("upload error target " + JSON.stringify(error));
            }

        }
    </script>

</body>

</html>