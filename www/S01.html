<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta http-equiv="Content-Security-Policy" content="default-src *;
    img-src * 'self' data: https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' *;
    style-src  'self' 'unsafe-inline' *">
    <!-- 匯入ionicons 字型圖標 -->
    <link rel="stylesheet" href="css/ionicons.min.css">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!--匯入滾輪-->
    <link rel="stylesheet" href="css/mobileSelect.css">
    <link rel=stylesheet type="text/css" href="css/S01.css">
    <script src="js/mobileSelect.js"></script>
    <script src="cordova.js" type="text/javascript"></script>
    <script type="text/javascript" charset="utf-8"></script>
    <title>Search</title>
</head>

<body class="font" style="background-color: #ffffff">
    <div class="lead" onclick="lead()">
        <div class="mask"></div>
        <p id="leadcaption" class="caption">請輸入物品名稱的關鍵字<br>來進行搜尋</p>
        <img src="static/tap.png" id="leadarrow" class="arrow">
        <!-- <i class="icon ion-md-arrow-round-back arrow"></i> -->
        <div id="leadknow" class="know">我知道了</div>
    </div>

    <div class=" flex ">
        <div class="row" style="height: 100px;">
            <div class="col" style="height:70px; ">
                <span class="searchtext" style="line-height: 100px"> <b class="s">Search</b></span>


            </div>
            <div class="col" style="height:70px ">
                <div>
                    <svg class="w3-animate-fading" id="圖層_1" data-name="圖層 1" xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 595.28 595.28" style="  width: 120px;
                                            height: 120px; ">
                        <defs>
                            <style>
                                .cls-2 {
                                    fill: #fff;

                                }
                            </style>
                        </defs>
                        <!-- <title>專題logo藍底白字</title> -->
                        <!-- <rect class="cls-1" width="300" height="595.28" /> -->
                        <path class="cls-2"
                            d="M363.53,81.34l-31.68-.78a8.73,8.73,0,0,0-7.53,4l-41.17,63.78a8.7,8.7,0,0,1-8.07,4l-14.14-1.23a6.68,6.68,0,0,1-4.95-10.4l33.42-49.2a8.72,8.72,0,0,0-6.89-13.6L205.75,75a8.7,8.7,0,0,0-7.48,3.76L119.61,192.68a8.75,8.75,0,0,0-1.54,4.95V349.92a8.72,8.72,0,0,0,6.24,8.36L191,377.92a8.7,8.7,0,0,0,11.17-8.3l.42-75.91a8.72,8.72,0,0,1,10.36-8.51L232.6,289a8.72,8.72,0,0,1,7.06,8.65l-.92,85.28a8.7,8.7,0,0,0,6.8,8.6L314,406.88a8.71,8.71,0,0,0,10.61-8.26l4.49-162.28a8.7,8.7,0,0,1,1.61-4.82L399.55,135a8.71,8.71,0,0,1,13.13-1.22l44.05,42.45a8.72,8.72,0,0,1,2.67,6.3l-.33,115.66a8.72,8.72,0,0,1-4.1,7.36l-4.73,3A8.71,8.71,0,0,1,436.91,301l.39-48.46a8.7,8.7,0,0,0-3.39-7l-27.23-21a8.71,8.71,0,0,0-12.32,1.71l-34.48,46.57a8.78,8.78,0,0,0-1.71,5.13l-.49,78.2a8.7,8.7,0,0,1-3.9,7.21l-12.26,8.13a8.71,8.71,0,0,0-3.9,7l-.34,13.33a8.72,8.72,0,0,0,13.41,7.56L381.09,380a8.7,8.7,0,0,0,4-7.34V285.79a4.86,4.86,0,0,1,.84-2.74l14.26-21.2a8.72,8.72,0,0,1,12-2.41h0a8.73,8.73,0,0,1,3.91,7.29L416,340.29a8.71,8.71,0,0,0,13.15,7.52l50.26-29.76a8.73,8.73,0,0,0,4.27-7.5V167a8.7,8.7,0,0,0-2.86-6.45L403.26,90.17a8.7,8.7,0,0,0-13,1.51L300.69,221.76a8.7,8.7,0,0,0-1.54,4.94v140a8.71,8.71,0,0,1-10.5,8.53l-16.57-3.5a8.69,8.69,0,0,1-6.91-8.62l1.05-89.2a8.72,8.72,0,0,0-7.18-8.68l-70-12.5a8.71,8.71,0,0,0-10.24,8.48L178,335a8.71,8.71,0,0,1-11.09,8.28l-15.58-4.42a8.72,8.72,0,0,1-6.33-8.34l-.5-125.86a8.66,8.66,0,0,1,1.55-5L215.43,99.33a8.74,8.74,0,0,1,7.66-3.74l15.43.89a8.71,8.71,0,0,1,6.84,13.4L213.9,158.93a8.72,8.72,0,0,0,6.34,13.36l64.83,7.48a8.72,8.72,0,0,0,8.24-3.81L340,106.18a8.71,8.71,0,0,1,7.24-3.87H361a8.73,8.73,0,0,0,7.31-4l2.31-3.56A8.71,8.71,0,0,0,363.53,81.34Z" />

                    </svg></div>
            </div>
        </div>
        <div class="row" style="margin-bottom: 40px;width: 100%">
            <input type="text" id="searchinput" placeholder="    Search something" oninput="filtersearch();">
        </div>





    </div>



    <div class="bordertype col-md-8 offset-md-2 col-lg-6 offset-lg-3">

        <div class="container px-lg-5 btnstyle" style="margin-top:10px">
            <button type="button" class="buttontype  tablink upcon1" id="categorysearch">類別</button>
            <button type="button" class="buttontype tablink upcon1" id="ownersearch">所屬人</button>
            <button type="button" class="buttontype  tablink upcon2 " id="thingon" onclick="outgood();">未放回物品 </button>
        </div>
        <br>
        <div class=" searchcontent">
            <div class="box-wrap">

            </div>
        </div>
    </div>

    <div class="container-fluid  footer">
        <div class="row row1 ">
            <div class="col-4 icon">
                <a href="S01.html">
                    <i class="icon ion-md-search icon1" style="color: #254F6E"></i>
                </a> </div>
            <div class="col-4 icon ">
                <a href="H01.html">
                    <i class="icon ion-md-home icon1"></i>
                </a> </div>
            <div class="col-4 icon">
                <a href="A01.html">
                    <i class="icon ion-md-bookmarks icon1"></i>
                </a>
            </div>

        </div>

    </div>


    <script type="text/javascript" charset="UTF-8">

        //引導頁
        function lead() {
            $('.lead').attr('onclick', 'lead2()');
            $(".arrow").css({ "left": "35px", "top": "250px" });
            $(".caption").css("top", "350px");
            $("#leadcaption").html("點選類別按鈕<br>可依照類別進行搜尋")
            $(".know").css("top", "450px");
        }
        function lead2() {
            $('.lead').attr('onclick', 'lead3()');
            $(".arrow").css({ "left": "140px", "top": "250px" });
            $(".caption").css({ "left": "100px", "top": "350px" });
            $("#leadcaption").html("點選所屬人按鈕<br>可依照所屬人進行搜尋")
            $(".know").css("top", "450px");
        }
        function lead3() {
            $('.lead').attr('onclick', 'lead4()');
            $(".arrow").css({ "left": "250px", "top": "250px" });
            $(".caption").css({ "left": "120px", "top": "350px" });
            $("#leadcaption").html("點選未放回物品的按鈕<br>可搜尋尚未放回之物品")
            $(".know").css("top", "450px");
        }
        function lead4() {
            $(".lead").css('display', 'none');
        }




        //資料庫
        document.addEventListener("deviceready", onDeviceReady, false);
        var db;
        var categorypicker
        var ownerpicker
        var user_email;
        var user_token;
        var user_id;
        function onDeviceReady() {
            db = window.sqlitePlugin.openDatabase({
                name: 'my.db',
                location: 'default',
            });
            //提醒跳轉
            cordova.plugins.notification.local.on("click", function (notification) {
                window.location.href = 'T01_edit.html?thing=' + notification.thingId + ''
            });

            db.transaction(function (tx) {
                tx.executeSql('CREATE TABLE IF NOT EXISTS user (id integer primary key, email text, token text, nickname text, backup text)');
                tx.executeSql('CREATE TABLE IF NOT EXISTS thing (id text primary key, name text, description text, image text, category text, owner text, furniture_id text, number integer, layer text, out integer, remind integer, time date, content text)');
                tx.executeSql('CREATE TABLE IF NOT EXISTS category (id text primary key, name text, user_id integer)');
                tx.executeSql('CREATE TABLE IF NOT EXISTS owner (id text primary key, name text, user_id integer)');
                tx.executeSql('CREATE TABLE IF NOT EXISTS page (id integer primary key, home integer, furniture_page integer, search_page integer, post_page integer)');
            });

            db.transaction(function (tx) {

                tx.executeSql("SELECT * FROM page", [],
                    function (tx, res) {
                        var len = res.rows.length;
                        if (res.rows.length >= 1) {
                            var search_page = res.rows.item(0)['search_page']
                            if (!search_page) {
                                $(".lead").css('display', 'block');
                                tx.executeSql("UPDATE page SET search_page = ? WHERE id = ?", [1, 1]);
                            }
                        }
                    });

                tx.executeSql('SELECT * FROM user', [],
                    function (tx, res) {
                        var len = res.rows.length;
                        if (res.rows.length >= 1) {
                            user_email = res.rows.item(0)['email'];
                            user_token = res.rows.item(0)['token'];
                            user_id = res.rows.item(0)['id'];

                            //類別滾輪
                            var categoryselect = []
                            var categoryselect2 = ['包包', '鞋子', '衣服', '文具', '工具', '玩具', '杯子', '飾品', '化妝品', '眼鏡']
                            tx.executeSql('SELECT * FROM category WHERE user_id=?', [res.rows.item(0)['id']],
                                function (tx, res) {
                                    var len = res.rows.length;
                                    if (res.rows.length >= 1) {
                                        for (var i = 0; i < len; i++) {
                                            categoryselect.push(res.rows.item(i)['name'])
                                        }
                                    }
                                    var categoryselect3 = categoryselect.concat(categoryselect2)
                                    categorypicker = new MobileSelect({
                                        trigger: '#categorysearch',
                                        title: '類別',
                                        cancelBtnColor: '#f0f0f0',
                                        ensureBtnColor: '#f0f0f0',
                                        titleBgColor: '#254F6E',
                                        titleColor: '#f0f0f0',
                                        ensureBtnText: '確認',
                                        wheels: [
                                            { data: categoryselect3 }
                                        ],
                                        position: [0],
                                        callback: function (indexArr, data) {
                                            searchcate();

                                        } //初始化定位        

                                    });

                                }, function (error) {
                                    alert('Something went Wrong');
                                });


                            //所屬人滾輪
                            var ownerselect = []
                            var ownerselect2 = ['自己', '爸爸', '媽媽', '哥哥', '弟弟', '姊姊', '妹妹', '爺爺', '奶奶', '朋友', '同事']
                            tx.executeSql('SELECT * FROM owner WHERE user_id=?', [res.rows.item(0)['id']],
                                function (tx, res) {
                                    var len = res.rows.length;
                                    if (res.rows.length >= 1) {
                                        for (var i = 0; i < len; i++) {
                                            ownerselect.push(res.rows.item(i)['name'])
                                        }
                                    }
                                    var ownerselect3 = ownerselect.concat(ownerselect2)

                                    ownerpicker = new MobileSelect({
                                        trigger: '#ownersearch',
                                        title: '所屬人',
                                        cancelBtnColor: '#f0f0f0',
                                        ensureBtnColor: '#f0f0f0',
                                        titleBgColor: '#254F6E',
                                        titleColor: '#f0f0f0',
                                        ensureBtnText: '確認',
                                        wheels: [
                                            { data: ownerselect3 }
                                        ],
                                        position: [0], //初始化定位
                                        callback: function (indexArr, data) {
                                            searchown();
                                        }
                                    });
                                }, function (error) {
                                    alert('Something went Wrong');
                                });


                        }
                    });
            });

        }

        function searchcate() {
            var ownerValue = $("#ownersearch").text();
            var cateValue = $("#categorysearch").text();

            db.transaction(function (tx) {
                $(".box-wrap").html("")
                tx.executeSql('SELECT * FROM planargraph WHERE user_id = ?', [user_id], function (tx, res) {
                    if (res.rows.length >= 1) {
                        var len = res.rows.length;
                        for (var y = 0; y < len; y++) {
                            var tran = function (y) {
                                tx.executeSql('SELECT * FROM space WHERE planargraph_id = ?', [res.rows.item(y)['id']],
                                    function (tx, res) {
                                        var len = res.rows.length;
                                        if (res.rows.length >= 1) {
                                            for (var i = 0; i < len; i++) {
                                                var spaceId = res.rows.item(i)['id'];
                                                var tr = function (spaceId) {
                                                    tx.executeSql('SELECT * FROM furniture WHERE space_id = ?', [spaceId], function (tx, res) {
                                                        var len = res.rows.length;
                                                        if (res.rows.length >= 1) {
                                                            for (var x = 0; x < len; x++) {
                                                                var furnitureId = res.rows.item(x)['id'];
                                                                var trans = function (furnitureId) {
                                                                    if (ownerValue != "所屬人") {//呈現所屬人與類別物品
                                                                        db.transaction(function (tx) {
                                                                            $(".box-wrap").html("")
                                                                            tx.executeSql('SELECT * FROM thing WHERE furniture_id = ?', [furnitureId], function (tx, res) {
                                                                                if (res.rows.length >= 1) {
                                                                                    for (var j = 0; j < res.rows.length; j++) {
                                                                                        if (res.rows.item(j)['owner'] == ownerValue && res.rows.item(j)['category'] == cateValue) {
                                                                                            $(".box-wrap").append(`<div class="box">
                                                                                            <a href="T01_edit.html?thing=`+ res.rows.item(j)['id'] + `">
                                                                                            <img src="` + res.rows.item(j)['image'] + `" style=width:100%;height:100%>
                                                                                            </a>
                                                                                            </div>`)
                                                                                        }
                                                                                    }
                                                                                }
                                                                            });
                                                                        });
                                                                    } else {
                                                                        $(".box-wrap").html("")
                                                                        tx.executeSql('SELECT * FROM thing WHERE furniture_id = ?', [furnitureId], function (tx, res) {
                                                                            if (res.rows.length >= 1) {
                                                                                for (var j = 0; j < res.rows.length; j++) {
                                                                                    if (res.rows.item(j)['category'] == cateValue) {
                                                                                        $(".box-wrap").append(`<div class="box">
                                                                                        <a href="T01_edit.html?thing=`+ res.rows.item(j)['id'] + `">
                                                                                        <img src="` + res.rows.item(j)['image'] + `" style=width:100%;height:100%>
                                                                                        </a>
                                                                                        </div>`)
                                                                                    }

                                                                                }
                                                                            }
                                                                        });
                                                                    }
                                                                }(furnitureId)
                                                            }
                                                        }

                                                    });
                                                }(spaceId)
                                            }
                                        }
                                    });
                            }(y)
                        }
                    }
                });
            });
        }





        function searchown() {
            var ownerValue = $("#ownersearch").text();
            var cateValue = $("#categorysearch").text();

            db.transaction(function (tx) {
                $(".box-wrap").html("")
                tx.executeSql('SELECT * FROM planargraph WHERE user_id = ?', [user_id], function (tx, res) {
                    if (res.rows.length >= 1) {
                        var len = res.rows.length;
                        for (var y = 0; y < len; y++) {
                            var tran = function (y) {
                                tx.executeSql('SELECT * FROM space WHERE planargraph_id = ?', [res.rows.item(y)['id']],
                                    function (tx, res) {
                                        var len = res.rows.length;
                                        if (res.rows.length >= 1) {
                                            for (var i = 0; i < len; i++) {
                                                var spaceId = res.rows.item(i)['id'];
                                                var tr = function (spaceId) {
                                                    tx.executeSql('SELECT * FROM furniture WHERE space_id = ?', [spaceId], function (tx, res) {
                                                        var len = res.rows.length;
                                                        if (res.rows.length >= 1) {
                                                            for (var x = 0; x < len; x++) {
                                                                var furnitureId = res.rows.item(x)['id'];
                                                                var trans = function (furnitureId) {
                                                                    if (cateValue != "類別") {
                                                                        //呈現所屬人與類別物品                                                                        
                                                                        $(".box-wrap").html("");
                                                                        tx.executeSql('SELECT * FROM thing WHERE furniture_id = ?', [furnitureId], function (tx, res) {
                                                                            if (res.rows.length >= 1) {
                                                                                for (var j = 0; j < res.rows.length; j++) {
                                                                                    if (res.rows.item(j)['owner'] == ownerValue && res.rows.item(j)['category'] == cateValue) {
                                                                                        $(".box-wrap").append(`<div class="box">
                                                                                            <a href="T01_edit.html?thing=`+ res.rows.item(j)['id'] + `">
                                                                                            <img src="` + res.rows.item(j)['image'] + `" style=width:100%;height:100%>
                                                                                            </a>
                                                                                            </div>`)
                                                                                    }
                                                                                }
                                                                            }
                                                                        });

                                                                    } else { //單一所屬人搜尋                                                                         
                                                                        $(".box-wrap").html("");
                                                                        tx.executeSql('SELECT * FROM thing WHERE furniture_id = ?', [furnitureId], function (tx, res) {
                                                                            if (res.rows.length >= 1) {
                                                                                for (var j = 0; j < res.rows.length; j++) {
                                                                                    if (res.rows.item(j)['owner'] == ownerValue) {
                                                                                        $(".box-wrap").append(`<div class="box">
                                                                                        <a href="T01_edit.html?thing=`+ res.rows.item(j)['id'] + `">
                                                                                        <img src="` + res.rows.item(j)['image'] + `" style=width:100%;height:100%>
                                                                                        </a>
                                                                                        </div>`)
                                                                                    }

                                                                                }

                                                                            }
                                                                        });
                                                                    }
                                                                }(furnitureId)
                                                            }
                                                        }

                                                    });
                                                }(spaceId)
                                            }
                                        }
                                    });
                            }(y)
                        }
                    }
                });
            });
        }

        function outgood() {
            db.transaction(function (tx) {
                $(".box-wrap").html("")
                tx.executeSql('SELECT * FROM planargraph WHERE user_id = ?', [user_id], function (tx, res) {
                    if (res.rows.length >= 1) {
                        var len = res.rows.length;
                        for (var y = 0; y < len; y++) {
                            var tran = function (y) {
                                tx.executeSql('SELECT * FROM space WHERE planargraph_id = ?', [res.rows.item(y)['id']],
                                    function (tx, res) {
                                        var len = res.rows.length;
                                        if (res.rows.length >= 1) {
                                            for (var i = 0; i < len; i++) {
                                                var spaceId = res.rows.item(i)['id'];
                                                var tr = function (spaceId) {
                                                    tx.executeSql('SELECT * FROM furniture WHERE space_id = ?', [spaceId], function (tx, res) {
                                                        var len = res.rows.length;
                                                        if (res.rows.length >= 1) {
                                                            for (var x = 0; x < len; x++) {
                                                                var furnitureId = res.rows.item(x)['id'];
                                                                var trans = function (furnitureId) {
                                                                    //呈現未放回物品
                                                                    $(".box-wrap").html("")
                                                                    tx.executeSql('SELECT * FROM thing WHERE furniture_id = ?', [furnitureId], function (tx, res) {
                                                                        if (res.rows.length >= 1) {
                                                                            for (var j = 0; j < res.rows.length; j++) {
                                                                                if (res.rows.item(j)['out'] == 1) {
                                                                                    $(".box-wrap").append(`<div class="box">
                                                                                    <a href="T01_edit.html?thing=`+ res.rows.item(j)['id'] + `">
                                                                                    <img src="` + res.rows.item(j)['image'] + `" style=width:100%;height:100%>
                                                                                    </a>
                                                                                    </div>`)
                                                                                }
                                                                            }
                                                                        }
                                                                    });
                                                                }(furnitureId)
                                                            }
                                                        }
                                                    });
                                                }(spaceId)
                                            }
                                        }
                                    });
                            }(y)
                        }
                    }
                });
            });

        }

        function filtersearch() {
            var inputValue = $("#searchinput").val();
            var inputevalue2 = String(inputValue)
            if (inputValue == "") {
                $(".box-wrap").html("")
            } else {

                db.transaction(function (tx) {
                    $(".box-wrap").html("")
                    tx.executeSql('SELECT * FROM planargraph WHERE user_id = ?', [user_id], function (tx, res) {
                        if (res.rows.length >= 1) {
                            var len = res.rows.length;
                            for (var y = 0; y < len; y++) {
                                var tran = function (y) {
                                    tx.executeSql('SELECT * FROM space WHERE planargraph_id = ?', [res.rows.item(y)['id']],
                                        function (tx, res) {
                                            var len = res.rows.length;
                                            if (res.rows.length >= 1) {
                                                for (var i = 0; i < len; i++) {
                                                    var spaceId = res.rows.item(i)['id'];
                                                    var tr = function (spaceId) {
                                                        tx.executeSql('SELECT * FROM furniture WHERE space_id = ?', [spaceId], function (tx, res) {
                                                            var len = res.rows.length;
                                                            if (res.rows.length >= 1) {
                                                                for (var x = 0; x < len; x++) {
                                                                    var furnitureId = res.rows.item(x)['id'];
                                                                    var trans = function (furnitureId) {
                                                                        $(".box-wrap").html("")
                                                                        tx.executeSql('SELECT * FROM thing WHERE name LIKE? or description LIKE? and furniture_id = ? ', ['%' + inputevalue2 + '%', '%' + inputevalue2 + '%', furnitureId], function (tx, res) {
                                                                            if (res.rows.length >= 1) {
                                                                                for (var j = 0; j < res.rows.length; j++) {
                                                                                    $(".box-wrap").append(`<div class="box">
                                                                                        <a href="T01_edit.html?thing=`+ res.rows.item(j)['id'] + `">
                                                                                        <img src="` + res.rows.item(j)['image'] + `" style=width:100%;height:100%>
                                                                                        </a>
                                                                                        </div>`)
                                                                                }
                                                                            }
                                                                        });
                                                                    }(furnitureId)
                                                                }
                                                            }
                                                        });
                                                    }(spaceId)
                                                }
                                            }
                                        });
                                }(y)
                            }
                        }
                    });
                });
            }
        }


    </script>

</body>

</html>